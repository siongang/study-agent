# Data Directory

Documentation for the `data/` directory structure.

---

## Overview

The `data/` directory contains all artifacts generated by the system:

- **Source PDFs** (user-provided)
- **Extracted structure** (topics, chunks)
- **Embeddings** (vector indexes)
- **Study plans** (generated schedules)

All files are **local** and **persistent**.

---

## Directory Structure

```
data/
├── uploads/          # User places PDFs here
├── topics/           # Extracted topic inventories (JSON)
├── chunks/           # Text chunks with metadata (JSON)
├── indexes/          # Vector store persistence (ChromaDB)
└── plans/            # Generated study plans (Markdown + JSON)
```

---

## `uploads/`

**Purpose**: Source textbooks (PDFs).

**User responsibility**:
- Manually place PDFs here
- Use descriptive filenames (e.g., `physics.pdf`, `biology.pdf`)

**Example**:

```bash
data/uploads/
├── physics.pdf
├── biology.pdf
└── chemistry.pdf
```

**Notes**:
- Files must be valid PDFs
- Encrypted PDFs not supported
- Large files (>100MB) may take longer to ingest

**Handling changes**:
- **Add**: Place new PDF → system auto-detects
- **Replace**: Overwrite existing PDF → system detects hash change → re-ingests
- **Remove**: Delete PDF → system invalidates plan

---

## `topics/`

**Purpose**: Extracted topic inventories (source of truth for coverage).

**Format**: JSON

**Naming**: `<course>.json` (e.g., `physics.json`)

**Example file** (`topics/physics.json`):

```json
{
  "course": "Physics",
  "topics": [
    {
      "topic_id": "phys_1",
      "title": "Kinematics",
      "page_range": [1, 34],
      "subtopics": [
        {
          "topic_id": "phys_1_1",
          "title": "Displacement",
          "page_range": [2, 6],
          "subtopics": []
        },
        {
          "topic_id": "phys_1_2",
          "title": "Velocity",
          "page_range": [7, 15],
          "subtopics": []
        }
      ]
    },
    {
      "topic_id": "phys_2",
      "title": "Dynamics",
      "page_range": [35, 67],
      "subtopics": [
        {
          "topic_id": "phys_2_1",
          "title": "Newton's Laws",
          "page_range": [35, 50],
          "subtopics": []
        }
      ]
    }
  ]
}
```

**Key fields**:
- `topic_id`: Unique identifier (used for scheduling)
- `title`: Human-readable name
- `page_range`: `[start_page, end_page]` (inclusive)
- `subtopics`: Nested structure (hierarchical)

**Usage**:
- **PlannerAgent** uses this to know what topics exist
- **VerifierAgent** uses this to check coverage
- **TutorAgent** uses this to scope retrieval

**Lifecycle**:
- Generated by `IngestionAgent`
- Read by `PlannerAgent`, `VerifierAgent`, `TutorAgent`
- Deleted when textbook is re-ingested

---

## `chunks/`

**Purpose**: Text chunks with metadata for embedding.

**Format**: JSON

**Naming**: `<course>.json`

**Example file** (`chunks/physics.json`):

```json
{
  "course": "Physics",
  "chunks": [
    {
      "chunk_id": "c_0001",
      "topic_id": "phys_1_1",
      "text": "Displacement is a vector quantity that describes the change in position of an object. Unlike distance, which is scalar, displacement has both magnitude and direction...",
      "pages": [2, 3],
      "token_count": 487
    },
    {
      "chunk_id": "c_0002",
      "topic_id": "phys_1_2",
      "text": "Velocity is defined as the rate of change of displacement with respect to time. It is calculated as v = Δx / Δt, where Δx is displacement and Δt is time interval...",
      "pages": [7, 8],
      "token_count": 512
    }
  ]
}
```

**Key fields**:
- `chunk_id`: Unique identifier
- `topic_id`: Links chunk to topic
- `text`: Actual text content
- `pages`: Page numbers this chunk came from
- `token_count`: Number of tokens (for tracking)

**Chunking strategy**:
- Default size: 512 tokens
- Overlap: 128 tokens (to preserve context)
- Topic-aware: chunks don't cross topic boundaries

**Usage**:
- **Embedder** generates vectors from these
- **VectorStore** stores these with embeddings
- **TutorAgent** retrieves these during RAG

---

## `indexes/`

**Purpose**: Vector store persistence (ChromaDB).

**Structure**: One directory per course

**Example**:

```
data/indexes/
├── physics/
│   ├── chroma.sqlite3        # ChromaDB database
│   ├── index/                # Vector index files
│   └── metadata.json         # Collection metadata
├── biology/
│   ├── chroma.sqlite3
│   ├── index/
│   └── metadata.json
└── chemistry/
    ├── chroma.sqlite3
    ├── index/
    └── metadata.json
```

**Contents**:
- **Embeddings**: Vector representations of chunks
- **Metadata**: `topic_id`, `pages`, `course`
- **Full text**: Original chunk text (for retrieval)

**Size**: ~1-2MB per 100 chunks

**Usage**:
- **TutorAgent** queries this for RAG
- **VectorStore** reads/writes here

**Persistence**:
- Automatically managed by ChromaDB
- Safe to delete and regenerate (just re-run ingestion)

---

## `plans/`

**Purpose**: Generated study plans.

**Formats**: Markdown (human-readable) + JSON (machine-readable)

**Example files**:

```
data/plans/
├── study_plan.md         # Human-readable
└── study_plan.json       # Machine-readable
```

### `study_plan.md` (Markdown)

```markdown
# Study Plan

Generated: 2026-02-05 10:23:11

## Overview

- **Period**: Feb 5 - Feb 25 (20 days)
- **Courses**: Physics, Biology
- **Total topics**: 42
- **Average workload**: 2.8 hrs/day

## Coverage

- Physics: 18/18 topics ✓
- Biology: 24/24 topics ✓

---

## Daily Schedule

### Tuesday, February 5

**Physics** (2.5 hrs):
- Kinematics (pp. 1-34)
- Displacement (pp. 2-6)

**Biology** (1.5 hrs):
- Cell Structure (pp. 12-45)

**Total**: 4.0 hrs

---

### Wednesday, February 6

**Physics** (2.0 hrs):
- Velocity (pp. 7-15)

**Biology** (2.0 hrs):
- Cell Division (pp. 46-78)

**Total**: 4.0 hrs

---

... (continues for all days)
```

### `study_plan.json` (JSON)

```json
{
  "generated_at": "2026-02-05T10:23:11Z",
  "period": {
    "start": "2026-02-05",
    "end": "2026-02-25"
  },
  "courses": ["Physics", "Biology"],
  "schedule": {
    "2026-02-05": [
      {
        "topic_id": "phys_1",
        "title": "Kinematics",
        "course": "Physics",
        "effort_hours": 2.5,
        "pages": [1, 34]
      },
      {
        "topic_id": "bio_1",
        "title": "Cell Structure",
        "course": "Biology",
        "effort_hours": 1.5,
        "pages": [12, 45]
      }
    ],
    "2026-02-06": [
      {
        "topic_id": "phys_1_2",
        "title": "Velocity",
        "course": "Physics",
        "effort_hours": 2.0,
        "pages": [7, 15]
      }
    ]
  },
  "coverage": {
    "Physics": {
      "total": 18,
      "scheduled": 18,
      "percentage": 100.0
    },
    "Biology": {
      "total": 24,
      "scheduled": 24,
      "percentage": 100.0
    }
  }
}
```

**Usage**:
- **User** reads `.md` file
- **Agents** read `.json` file for verification/updates

---

## File Lifecycle

### 1. Initial ingestion

```
User places physics.pdf in uploads/
         ↓
IngestionAgent runs:
  - Generates topics/physics.json
  - Generates chunks/physics.json
  - Creates indexes/physics/
```

### 2. Plan generation

```
User requests plan
         ↓
PlannerAgent runs:
  - Reads topics/physics.json
  - Reads topics/biology.json
  - Generates plans/study_plan.{md,json}
```

### 3. Textbook replacement

```
User replaces physics.pdf
         ↓
RootAgent detects change:
  - Deletes topics/physics.json
  - Deletes chunks/physics.json
  - Deletes indexes/physics/
  - Marks plan as invalid
         ↓
IngestionAgent re-runs:
  - Regenerates all artifacts
```

---

## Disk Space Usage

Approximate sizes:

| Artifact | Size per textbook |
|----------|-------------------|
| PDF (upload) | 10-50 MB |
| Topics JSON | 10-50 KB |
| Chunks JSON | 500 KB - 2 MB |
| Vector index | 5-20 MB |
| Study plan | 10-50 KB |

**Example**: 3 textbooks (~30 MB each) + artifacts = ~150 MB total.

---

## Backup Strategy

To backup your data:

```bash
# Backup everything (including PDFs)
tar -czf study_agent_backup.tar.gz data/

# Backup only generated artifacts (no PDFs)
tar -czf artifacts_backup.tar.gz data/topics data/chunks data/indexes data/plans
```

To restore:

```bash
tar -xzf study_agent_backup.tar.gz
```

---

## Cleaning Up

### Remove all artifacts (keep PDFs)

```bash
rm -rf data/topics/*
rm -rf data/chunks/*
rm -rf data/indexes/*
rm -rf data/plans/*
```

Then re-run ingestion:

```
> Ingest all textbooks
```

### Remove everything (fresh start)

```bash
rm -rf data/uploads/*
rm -rf data/topics/*
rm -rf data/chunks/*
rm -rf data/indexes/*
rm -rf data/plans/*
```

---

## Invalidation Rules

The system automatically invalidates artifacts when:

1. **PDF changed** (hash mismatch)
   - Deletes: `topics/<course>.json`, `chunks/<course>.json`, `indexes/<course>/`
   - Marks: Plan as invalid

2. **PDF removed**
   - Deletes: All artifacts for that course
   - Marks: Plan as invalid

3. **New PDF added**
   - Creates: New artifacts
   - Marks: Plan as invalid (needs regeneration)

---

## Security Notes

- **All files are local** — nothing uploaded to cloud
- **PDFs**: May contain personal notes/highlights (not extracted)
- **Plans**: Contain course names and dates (consider private)
- **Vector indexes**: Contain textbook content (respect copyright)

**Recommendation**: Add `data/` to `.gitignore` if sharing code.

---

## Future Enhancements

Planned additions:

1. **Progress tracking** (`data/progress/`)
   - Mark topics as complete
   - Track study sessions

2. **Logs** (`data/logs/`)
   - Ingestion logs
   - Agent decision logs

3. **Exports** (`data/exports/`)
   - ICS files (calendar)
   - PDF summaries

4. **Backups** (`data/backups/`)
   - Automatic timestamped backups
   - Version history for plans

---

## Troubleshooting

### Issue: "topics/ directory empty after ingestion"

**Cause**: Ingestion failed silently

**Fix**:
```bash
# Check logs (if enabled)
cat data/logs/ingestion.log

# Re-run ingestion
python -m app.agents.ingestion_agent data/uploads/physics.pdf
```

### Issue: "ChromaDB database locked"

**Cause**: Another process is using the vector store

**Fix**:
```bash
# Kill any running Python processes
pkill python

# Restart the application
python -m app.main
```

### Issue: "Plan is valid but looks wrong"

**Cause**: Stale plan not regenerated

**Fix**:
```
> Regenerate my study plan
```

---

## Directory Permissions

Ensure proper permissions:

```bash
chmod -R u+rw data/
```

This allows:
- Read/write for user
- No access for group/others

---

**Next**: [Application Code Structure →](../app/README.md)
